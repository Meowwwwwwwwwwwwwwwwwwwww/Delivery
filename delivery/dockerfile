# ---- Stage 1: Build React frontend ----
FROM node:18 as frontend-builder

WORKDIR /app
COPY delivery/frontend_build ./frontend_build
RUN cd frontend_build && npm install && npm run build

# ---- Stage 2: Build Django backend ----
FROM python:3.11

WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy Django project
COPY delivery ./delivery

# Copy built frontend from Stage 1
COPY --from=frontend-builder /app/frontend_build/build ./delivery/backend_project/static/

# Collect static files and run gunicorn
RUN python delivery/manage.py collectstatic --noinput

EXPOSE 8000
CMD ["gunicorn", "delivery.wsgi:application", "--bind", "0.0.0.0:8000"]
